



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>CQRS - Event Driven Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#command-query-responsibility-segregation-cqrs-pattern" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Event Driven Architecture" class="md-header-nav__button md-logo">
          
            <img src="../../images/cloud.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Event Driven Architecture
            </span>
            <span class="md-header-nav__topic">
              CQRS
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Event Driven Architecture" class="md-nav__button md-logo">
      
        <img src="../../images/cloud.png" width="48" height="48">
      
    </a>
    Event Driven Architecture
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../architecture/" title="Reference diagrams" class="md-nav__link">
      Reference diagrams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-src/" title="Event sources" class="md-nav__link">
      Event sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-backbone/" title="Event backbone" class="md-nav__link">
      Event backbone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-action/" title="Event actions" class="md-nav__link">
      Event actions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-state/" title="Event managed states" class="md-nav__link">
      Event managed states
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/arch/" title="Event Stream & Kafka architecture" class="md-nav__link">
      Event Stream & Kafka architecture
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Methodology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Methodology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/readme/" title="Event driven methodology" class="md-nav__link">
      Event driven methodology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/eventstorming/" title="Event Storming" class="md-nav__link">
      Event Storming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/analysis/readme/" title="Event Storming applied to container shipment analysis" class="md-nav__link">
      Event Storming applied to container shipment analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/ddd/" title="Domain driven design" class="md-nav__link">
      Domain driven design
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Event driven design patterns
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Event driven design patterns
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ED-patterns/" title="Event-driven patterns" class="md-nav__link">
      Event-driven patterns
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../event-sourcing/" title="Event Sourcing" class="md-nav__link">
      Event Sourcing
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        CQRS
      </label>
    
    <a href="./" title="CQRS" class="md-nav__link md-nav__link--active">
      CQRS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problems-and-constraints" title="Problems and Constraints" class="md-nav__link">
    Problems and Constraints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-and-pattern" title="Solution and Pattern" class="md-nav__link">
    Solution and Pattern
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-consistency-challenge" title="The consistency challenge" class="md-nav__link">
    The consistency challenge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cqrs-and-change-data-capture" title="CQRS and Change Data Capture" class="md-nav__link">
    CQRS and Change Data Capture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delay-in-the-view" title="Delay in the view" class="md-nav__link">
    Delay in the view
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-change" title="Schema change" class="md-nav__link">
    Schema change
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saga/" title="Saga" class="md-nav__link">
      Saga
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/kafka-stream/" title="Kafka streaming processing" class="md-nav__link">
      Kafka streaming processing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-data-ai-analytics/preparation/data-replication/" title="Data replication pattern" class="md-nav__link">
      Data replication pattern
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Reference implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Reference implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc" title="Container shipment implementation solution" class="md-nav__link">
      Container shipment implementation solution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Product guidances
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Product guidances
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/arch/" title="Kafka architecture" class="md-nav__link">
      Kafka architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/readme/" title="Kafka concepts summary" class="md-nav__link">
      Kafka concepts summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/producers/" title="Kafka producer development practices" class="md-nav__link">
      Kafka producer development practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/consumers/" title="Kafka consumer development practices" class="md-nav__link">
      Kafka consumer development practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/FAQ/" title="Kafka FAQ" class="md-nav__link">
      Kafka FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kafka/monitoring/" title="Kafka monitoring" class="md-nav__link">
      Kafka monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../serverless/" title="Serverless" class="md-nav__link">
      Serverless
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/es-ibm-cloud/" title="Event Streams IBM CLOUD deployment" class="md-nav__link">
      Event Streams IBM CLOUD deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/" title="Event Streams ICP deployment" class="md-nav__link">
      Event Streams ICP deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/kafka/" title="Kafka deployment" class="md-nav__link">
      Kafka deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/zookeeper/" title="Zookeeper deployment" class="md-nav__link">
      Zookeeper deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/postgresql/" title="Postgresql" class="md-nav__link">
      Postgresql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/Install_Ceph_on_ICP/" title="Ceph deployment on ICP" class="md-nav__link">
      Ceph deployment on ICP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/strimzi/deploy/" title="Kafka deployment with Strimzi" class="md-nav__link">
      Kafka deployment with Strimzi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/ibm-cloud-architecture/refarch-integration/blob/master/docs/icp/troubleshooting.md" title="ICP troubleshouting" class="md-nav__link">
      ICP troubleshouting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Real time analytics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Real time analytics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../rt-analytics/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/jbcodeforce/refarch-reefer-ml" title="Reefer Container Predictive Maintenance" class="md-nav__link">
      Reefer Container Predictive Maintenance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../training/eda-skill-journey/" title="Skill journey" class="md-nav__link">
      Skill journey
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../compendium/" title="Compendium" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problems-and-constraints" title="Problems and Constraints" class="md-nav__link">
    Problems and Constraints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-and-pattern" title="Solution and Pattern" class="md-nav__link">
    Solution and Pattern
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-consistency-challenge" title="The consistency challenge" class="md-nav__link">
    The consistency challenge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cqrs-and-change-data-capture" title="CQRS and Change Data Capture" class="md-nav__link">
    CQRS and Change Data Capture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delay-in-the-view" title="Delay in the view" class="md-nav__link">
    Delay in the view
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-change" title="Schema change" class="md-nav__link">
    Schema change
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-eda/edit/master/docs/design-patterns/cqrs.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="command-query-responsibility-segregation-cqrs-pattern">Command Query Responsibility Segregation (CQRS) pattern</h1>
<h2 id="problems-and-constraints">Problems and Constraints</h2>
<p>An app accesses data both to read the data and to modify the data. The primitive data tasks are often expressed as create, read, update, and delete (CRUD); using them is known as CRUDing the data. App code usually does not make much distinction between the tasks; individual operations often mix reading the data with changing the data as needed.</p>
<p>As part of application modernisation and the adoption of microservice, the database per service approach leads to interesting challenges of how to support business queries joining different data sources. </p>
<p>Each microservice should store and manage its own data, user interface may need to display data from several microservices, or a business report needs to combined data from multiple microservices. Where this query should be implemented?</p>
<p>Another example is an enterprise database of record managing data required by many apps. It can become overloaded with too many clients needing too many connections to run too many threads performing too many transactions—such that the database becomes a performance bottleneck and can even crash. If the database contains data that is used by much of the enterprise, how can it be made more scalable?</p>
<h2 id="solution-and-pattern">Solution and Pattern</h2>
<p>The CQRS pattern strictly segregates operations that read data from operations that update data, which can make using data much more manageable in several respects. An operation can read data (the R in CRUD) or can write data (the CUD in CRUD), but not both. Doing so can make the read operations and the write operations simpler to implement because their functionality is more finely focused. The operations can be developed independently, potentially by separate teams. The operations can be optimized independently and can evolve independently, following changing user requirements more easily. These optimized operations can scale better, perform better, and security can be applied more precisely. </p>
<p>When doing event sourcing and domain driven design, we event source the aggregates or root entities. Aggregate creates events that are persisted. On top of the simple create, update and read by ID operations, the business requirements want to perform complex queries that can't be answered by a single aggregate. By just using event sourcing to be able to respond to a query like "what are the orders of a customer", then we have to rebuild the history of all orders and filter per customer. It is a lot of computation. This is linked to the problem of having conflicting domain models between query and persistence.<br />
Command Query Responsibility Segregation, CQRS, separates the "command" operations, used to update application state (also named the 'write model'), from the "query/read" operations (the 'read model').  Updates are done as state notification events (change of state), and are persisted in the event log/store. On the "read model" side, you have the option of persisting the state in different stores optimized for how other applications may query/read the data.</p>
<p>The CQRS application pattern is frequently associated with event sourcing.</p>
<p>The following figure presents the high level principles:</p>
<p><img alt="" src="../images/cqrs.png" /></p>
<p>The service exposes CUD operations, some basic Read by Id and then queries APIs. The domain model is separated into write and read models. Combined with Event Sourcing (ES) the <code>write model</code> goes to the event store. Then we have a separate process that consumes those events and build a projection for future queries. The "write" part may persist in SQL while the read may use document oriented database with strong indexing and query capabilities. Or use in-memory database, or distributed cache... They do not need to be in the same language. With CQRS and ES the projections are retroactives. New query equals implementing new projection and read the events from the beginning of time or the recent committed state and snapshot. Read and write models are strongly decoupled and can evolve independently. It is important to note that the 'Command' part can still handle simple queries, primary-key based, like get order by id, or queries that do not involve joins.</p>
<p>With this structure, the <code>Read model</code> microservice will most likely consume events from multiple topics to build the data projection based on joining those data streams. A query, to assess if the cold-chain was respected on the fresh food order shipment, will go to the voyage, container metrics, and order to be able to answer this question. This is where CQRS shines.</p>
<p>A second view of the previous diagram presents how we can separate the API definition and management in a API gateway, the Order command and write model has its own microservice, the event sourcing supported by a Kafka topic, and the query - read model as a set of different microservices or event functions as a service:</p>
<p><img alt="" src="../images/cqrs-es-api.png" /></p>
<p>The <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms">shipment order microservice</a> is implementing this pattern. </p>
<p>Some implementation items to consider: </p>
<ul>
<li><strong>Consistency</strong> (ensure the data constraints are respected for each data transaction): CQRS without event sourcing has the same consistency guarantees as the database used to persist data and events. With Event Sourcing the consistency could be different, one for the "Write" model and one for the "Read" model. On write model, strong consistency is important to ensure the current state of the system is correct, so it leverages transaction, lock and sharding. On read side, we need less consistency, as they mostly work on stale data. Locking data on the read operation is not reasonable. </li>
<li><strong>Scalability</strong>: Separating read and write as two different microservices allows for high availability. Caching at the "read" level can be used to increase performance response time, and can be deployed as multiple standalone instances (Pods in kubernetes). It is also possible to separate the query implementations between different services. Functions as service / serverless are good technology choices to implement complex queries. </li>
<li><strong>Availability</strong>: As the "write" model is often strongly consistent, it impacts availability. This is a fact. The read model is eventually consistent so high availability is possible. In case of failure the system disables the writing of data but still be able to read them as they are served by different databases and services. </li>
</ul>
<p>With CQRS the "write" model can evolve overtime without impacting the read model, unless the event model changes. It adds some cost by adding more tables to implement the query parts. It allows smaller model, easier to understand. </p>
<p>CQRS results in an increased number of objects, with commands, operations, events,... and packaging in deployable components or containers. It adds potentially different type of data sources. It is more complex. </p>
<p>Some challenges to always consider: </p>
<ul>
<li>How to support event version management?</li>
<li>How much data to keep in the event store (history)?</li>
<li>How to adopt data duplication which results to eventual data consistency. </li>
</ul>
<p>The CQRS pattern was introduced by <a href="https://www.youtube.com/watch?v=JHGkaShoyNs">Greg Young</a>, and described in <a href="https://martinfowler.com/bliki/CQRS.html">Martin Fowler's work on microservices.</a></p>
<p>As you can see in previous figure, as soon as we see two arrows from the same component, we have to ask ourselves how does it work: the "write model" has to persist Order in its own database and then sends OrderCreated event to the topic... Should those operations be atomic and controlled with transaction? We are detailing this in next section.</p>
<h3 id="the-consistency-challenge">The consistency challenge</h3>
<p>As introduced in previous section there is potentially a problem of data consistency: the command part saves the data into the database and is not able to send the event to the topic, then consumers do not see the new or updated data.<br />
With traditional Java service, using JPA and JMS, the save and send operations can be part of the same transaction and both succeed or both failed.<br />
With event sourcing pattern, the source of trust is the event source. It acts as a version control system. So the service should start by creating the event (1) and then persists the data into the database, it uses a topic consumer, get the payload from the event (2) and uses this data to save in its local datasource (3). It derives state solely from the events. If it fails to save, it can persist the event to an error log (4) and then it will be possible to trigger the replay, via an admin API and Command Line Interface (5,6), by searching in the topic using this order id to replay the save operation. Here is a diagram to illustrate that process:</p>
<p><img alt="" src="../images/cqrs-es-error-handling.png" /></p>
<p>This implementation brings a problem on the <code>createOrder(order): order</code> operation, as the returned order was supposed to have the order id as unique key, so most likely, a key created by the database... To avoid this we can generate the key by code and enforce this key in the database if the underlying technology supports it. </p>
<p>It is important to clearly study the Kafka consumer API and the different parameters on how to support the read offset. We are addressing those implementation best practices in <a href="../../kafka/consumers/">our consumer note.</a></p>
<h3 id="cqrs-and-change-data-capture">CQRS and Change Data Capture</h3>
<p>There are other ways to support this dual operations level:</p>
<ul>
<li>There is the open source <a href="https://debezium.io/">Debezium tool</a> to help respond to insert, update and delete operations on database and generate event accordingly. It may not work on all database schema. </li>
<li>Write the order to the database and in the same transaction write to an event table. Then use a polling to get the events to send to kafka from this event table and delete the row in the table once the event is sent. </li>
<li>Use the Change Data Capture from the database transaction log and generate events from this log. The IBM <a href="https://www.ibm.com/support/knowledgecenter/cs/SSTRGZ_10.2.0/com.ibm.cdcdoc.mcadminguide.doc/concepts/overview_of_cdc.html">Infosphere CDC</a> product helps to implement this pattern. For more detail about this solution see <a href="https://www.ibm.com/cloud/garage/dte/producttour/ibm-infosphere-data-replication-product-tour">this product tour</a>.</li>
</ul>
<p>The CQRS implementation using CDC will look like in the following diagram:</p>
<p><img alt="" src="../images/cqrs-cdc.png" /></p>
<p>What is important to note is that the event needs to be flexible on the data payload. We are presenting a <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms#data-and-event-model">event model</a> in the reference implementation.</p>
<p>On the view side, updates to the view part need to be idempotent. </p>
<h3 id="delay-in-the-view">Delay in the view</h3>
<p>There is a delay between the data persistence and the availability of the data in the Read model. For most business applications, it is perfectly acceptable. In web based data access most of the data are at stale. </p>
<p>When there is a need for the client, calling the query operation, to know if the data is up-to-date, the service can define a versioning strategy. When the order data was entered in a form within a single page application like our <a href="https://github.com/ibm-cloud-architecture/refarch-kc-ui">kc- user interface</a>, the "create order" operation should return the order with its unique key freshly created and the Single Page Application will have the last data. Here is an example of such operation:</p>
<div class="codehilite"><pre><span></span><span class="nd">@POST</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">create</span><span class="o">(</span><span class="n">OrderCreate</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">dto</span><span class="o">.</span><span class="na">getProductID</span><span class="o">(),...);</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span><span class="n">order</span><span class="o">).</span><span class="na">build</span><span class="o">()</span>
<span class="o">}</span>
</pre></div>

<h3 id="schema-change">Schema change</h3>
<p>What to do when we need to add attribute to event?. So we need to create a versioninig schema for event structure. You need to use flexible schema like json schema, <a href="https://avro.apache.org/docs/current/">Apache Avro</a> or <a href="https://developers.google.com/protocol-buffers/">protocol buffer</a> and may be, add an event adapter (as a function?) to translate between the different event structures. </p>
<p><ToBeCompleted></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../event-sourcing/" title="Event Sourcing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Event Sourcing
              </span>
            </div>
          </a>
        
        
          <a href="../saga/" title="Saga" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Saga
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>