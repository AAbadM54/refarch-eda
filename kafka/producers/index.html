



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Kafka producer development practices - Event Driven Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-149377589-3", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#producers-considerations" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Event Driven Architecture" class="md-header-nav__button md-logo">
          
            <img src="../../images/cloud.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Event Driven Architecture
            </span>
            <span class="md-header-nav__topic">
              Kafka producer development practices
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Event Driven Architecture" class="md-nav__button md-logo">
      
        <img src="../../images/cloud.png" width="48" height="48">
      
    </a>
    Event Driven Architecture
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../architecture/" title="Reference diagrams" class="md-nav__link">
      Reference diagrams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-src/" title="Event sources" class="md-nav__link">
      Event sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-backbone/" title="Event backbone" class="md-nav__link">
      Event backbone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-action/" title="Event actions" class="md-nav__link">
      Event actions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-state/" title="Event managed states" class="md-nav__link">
      Event managed states
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../arch/" title="Event Stream & Kafka architecture" class="md-nav__link">
      Event Stream & Kafka architecture
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Methodology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Methodology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/readme/" title="Event driven methodology" class="md-nav__link">
      Event driven methodology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/eventstorming/" title="Event Storming" class="md-nav__link">
      Event Storming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/analysis/readme/" title="Event Storming applied to container shipment analysis" class="md-nav__link">
      Event Storming applied to container shipment analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/ddd/" title="Domain driven design for event based solution" class="md-nav__link">
      Domain driven design for event based solution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Event driven design patterns
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Event driven design patterns
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../design-patterns/ED-patterns/" title="Event-driven patterns" class="md-nav__link">
      Event-driven patterns
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../design-patterns/event-sourcing/" title="Event Sourcing" class="md-nav__link">
      Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../design-patterns/cqrs/" title="CQRS" class="md-nav__link">
      CQRS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../design-patterns/saga/" title="Saga" class="md-nav__link">
      Saga
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../design-patterns/data-replication/" title="Data replication pattern" class="md-nav__link">
      Data replication pattern
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Reference implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Reference implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc" title="Container shipment implementation solution" class="md-nav__link">
      Container shipment implementation solution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Product guidances
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Product guidances
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../readme/" title="Kafka concepts summary" class="md-nav__link">
      Kafka concepts summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../arch/" title="Architecture considerations" class="md-nav__link">
      Architecture considerations
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kafka producer development practices
      </label>
    
    <a href="./" title="Kafka producer development practices" class="md-nav__link md-nav__link--active">
      Kafka producer development practices
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#design-considerations" title="Design considerations" class="md-nav__link">
    Design considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typical-producer-code-structure" title="Typical producer code structure" class="md-nav__link">
    Typical producer code structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kafka-useful-producer-apis" title="Kafka useful Producer APIs" class="md-nav__link">
    Kafka useful Producer APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#properties-to-consider" title="Properties to consider" class="md-nav__link">
    Properties to consider
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-support-exactly-once-delivery" title="How to support exactly once delivery" class="md-nav__link">
    How to support exactly once delivery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-examples" title="Code Examples" class="md-nav__link">
    Code Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-readings" title="More readings" class="md-nav__link">
    More readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../consumers/" title="Kafka consumer development practices" class="md-nav__link">
      Kafka consumer development practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kafka-stream/" title="Kafka streaming processing" class="md-nav__link">
      Kafka streaming processing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../connect/" title="Kafka Connect" class="md-nav__link">
      Kafka Connect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../FAQ/" title="Kafka FAQ" class="md-nav__link">
      Kafka FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/avro/avro" title="Adopting Avro with Kafka" class="md-nav__link">
      Adopting Avro with Kafka
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Kafka monitoring" class="md-nav__link">
      Kafka monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../serverless/" title="Serverless" class="md-nav__link">
      Serverless
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/es-ibm-cloud/" title="Event Streams IBM CLOUD deployment" class="md-nav__link">
      Event Streams IBM CLOUD deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/" title="Event Streams Cloud Pak Integration deployment" class="md-nav__link">
      Event Streams Cloud Pak Integration deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/kafka/" title="Kafka deployment" class="md-nav__link">
      Kafka deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/zookeeper/" title="Zookeeper deployment" class="md-nav__link">
      Zookeeper deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/postgresql/" title="Postgresql" class="md-nav__link">
      Postgresql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/Install_Ceph_on_ICP/" title="Ceph deployment on ICP" class="md-nav__link">
      Ceph deployment on ICP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/strimzi/deploy/" title="Kafka deployment with Strimzi" class="md-nav__link">
      Kafka deployment with Strimzi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/ibm-cloud-architecture/refarch-integration/blob/master/docs/icp/troubleshooting.md" title="Troubleshouting" class="md-nav__link">
      Troubleshouting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Real time analytics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Real time analytics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../rt-analytics/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-reefer-ml" title="Reefer Container Predictive Maintenance" class="md-nav__link">
      Reefer Container Predictive Maintenance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../compendium/" title="Compendium" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#design-considerations" title="Design considerations" class="md-nav__link">
    Design considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typical-producer-code-structure" title="Typical producer code structure" class="md-nav__link">
    Typical producer code structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kafka-useful-producer-apis" title="Kafka useful Producer APIs" class="md-nav__link">
    Kafka useful Producer APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#properties-to-consider" title="Properties to consider" class="md-nav__link">
    Properties to consider
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-support-exactly-once-delivery" title="How to support exactly once delivery" class="md-nav__link">
    How to support exactly once delivery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-examples" title="Code Examples" class="md-nav__link">
    Code Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-readings" title="More readings" class="md-nav__link">
    More readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-eda/edit/master/docs/kafka/producers.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="producers-considerations">Producers considerations</h1>
<p>A producer is a thread safe kafka client API that publishes records to the cluster. It uses buffers, thread pool, and serializers to send data. They are stateless: the consumers is responsible to manage the offsets of the message they read. When the producer connects via the initial bootstrap connection, it gets the metadata about the topic - partition and the leader broker to connect to. The assignment of messages to partition is done following different algorithms: round-robin if there is no key specified, using the hash code of the key, or custom defined.</p>
<p>We recommend reading <a href="https://ibm.github.io/event-streams/about/producing-messages/">IBM Event streams producer guidelines</a> to understand how producers work with its configuration parameters.</p>
<h2 id="design-considerations">Design considerations</h2>
<p>When developing a record producer you need to assess the followings:</p>
<ul>
<li>What is the event payload to send? Is is an root aggregate, as domain driven design concept, with value objects that needs to be kept in sequence to be used as event sourcing? or order does not matter? Remember that when order is important, messages need to go to the same topic. When multiple partitions are used, the messages with the same key will go to the same partition to guaranty the order. See related discussions <a href="https://www.confluent.io/blog/put-several-event-types-kafka-topic/">from Martin Kleppmann on confluent web site</a>. Also to be exhaustive, it is possible to get a producer doing retries that could generate duplicate records as acknowledges may take time to come: within a batch of n records, if the producer did not get all the n acknowledges on time, it may resend the batch. This is where 'idempotence' becomes important (see later section).</li>
<li>Is there a strong requirement to manage the schema definition? If using one topic to manage all events about a business entity, then be sure to support a flexible <a href="https://avro.apache.org/docs/1.8.1/spec.html">avro schema</a>.</li>
<li>What is the expected throughput to send events? Event size * average throughput combined with the expected latency help to compute buffer size. By default, the buffer size is set at 32Mb, but can be configured with <code>buffer.memory</code> property. (See <a href="https://kafka.apache.org/10/javadoc/org/apache/kafka/clients/producer/ProducerConfig.html">producer configuration API</a></li>
<li>Can the producer batches events together to send them in batch over one send operation? By design kafka producers batch events.</li>
<li>
<p>Is there a risk for loosing communication? Tune the RETRIES_CONFIG and buffer size, and ensure to have at least 3 or even better 5, brokers within the cluster to maintain quorum in case of one failure. The client API is implemented to support reconnection.</p>
<ul>
<li>When deploying kafka on Kubernetes, it is important to proxy the broker URLs with a proxy server outside of kubernetes. The HAProxy needs to scale, and as the kafka traffic may be important, it may make sense to have a dedicated HAProxy for clients to brokers traffic. </li>
</ul>
</li>
<li>
<p>Assess <em>exactly once</em> delivery requirement. Look at idempotent producer: retries will not introduce duplicate records (see <a href="#how-to-support-exactly-once-delivery">section</a> below).</p>
</li>
<li>Partitions help to scale the consumer processing of messages, but it also helps the producer to be more efficient as it can send message in parallel to different partition.</li>
<li>Where the event timestamp comes from? Should the producer send operation set it or is it loaded from external data? Remember that <code>LogAppendTime</code> is considered to be processing time, and <code>CreateTime</code> is considered to be event time.</li>
</ul>
<h2 id="typical-producer-code-structure">Typical producer code structure</h2>
<p>The producer code, using java or python API, does the following steps:</p>
<ul>
<li>define producer properties</li>
<li>create a producer instance</li>
<li>send event records and get resulting metadata.</li>
</ul>
<p>Producers are thread safe. The send() operation is asynchronous and returns immediately once record has been stored in the buffer of records, and it is possible to add a callback to process the broker acknowledgement.</p>
<p><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/de10317023c1dee9fbf1e948d1389472db32ce1a/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderEventProducer.java#L58-L82">Here is an example of producer code.</a></p>
<h2 id="kafka-useful-producer-apis">Kafka useful Producer APIs</h2>
<p>Here is a list of common API to use in your producer and consumer code.</p>
<ul>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html">KafkaProducer</a> A Kafka client that publishes records to the Kafka cluster.  The send method is asynchronous. A producer is thread safe so we can have per topic to interface.</li>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/ProducerRecord.html">ProducerRecord</a> to be published to a topic</li>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/RecordMetadata.html">RecordMetadata</a> metadata for a record that has been acknowledged by the server.</li>
</ul>
<h2 id="properties-to-consider">Properties to consider</h2>
<p>The following properties are helpful to tune at each topic and producer and will vary depending on the requirements:  </p>
<table>
<thead>
<tr>
<th>Properties</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOOTSTRAP_SERVERS_CONFIG</td>
<td>A comma-separated list of host:port values for all the brokers deployed. So producer may use any brokers</td>
</tr>
<tr>
<td>KEY_SERIALIZER_CLASS_CONFIG and VALUE_SERIALIZER_CLASS_CONFIG</td>
<td>convert the keys and values into byte arrays. Using default String serializer should be a good solution for Json payload. For streaming app, use customer serializer.</td>
</tr>
<tr>
<td>ACKS_CONFIG</td>
<td>specifies the minimum number of acknowledgments from a broker that the producer will wait for before considering a record send completed. Values = all, 0, and 1. 0 is for fire and forget.</td>
</tr>
<tr>
<td>RETRIES_CONFIG</td>
<td>specifies the number of times to attempt to resend a batch of events.</td>
</tr>
<tr>
<td>ENABLE_IDEMPOTENCE_CONFIG</td>
<td>Set to true, the number of retries will be maximized, and the acks will be set to <code>All</code>.</td>
</tr>
</tbody>
</table>
<h2 id="how-to-support-exactly-once-delivery">How to support exactly once delivery</h2>
<p>Knowing that exactly once delivery is one of the hardest problems to solve in distributed systems, how kafka does it?. Broker can fail or a network may respond slowly while a producer is trying to send events.</p>
<p>Producer can set acknowledge level to control the delivery semantic:</p>
<ul>
<li><strong>At least once</strong>: means the producer set ACKS_CONFIG=1 and get an acknowledgement message when the message sent, has been written to at least one time in the cluster (assume replicas = 3).  If the ack is not received, the producer may retry, which may generate duplicate records in case the broker stops after saving to the topic and before sending back the acknowledgement message.</li>
<li><strong>At most semantic</strong>: means the producer will not do retry in case of no acknowldege received. It may create log and compensation, but the message is lost.</li>
<li><strong>Exactly once</strong> means even if the producer sends the message twice the system will send only one message to the consumer. Once the consumer commits the read offset, it will not receive the message again, even if it restarts. Consumer offset needs to be in sync with produced event.</li>
</ul>
<p>With the idempotence property (ENABLE_IDEMPOTENCE_CONFIG = true), the record sent, has a sequence number and a producer id, so that the broker keeps the last sequence number per producer and per partition. </p>
<p><img alt="Exactly once" src="../images/exactly-one-1.png" /></p>
<p>If a message is received with a lower sequence number, it means a producer is doing some retries on record already processed, so the broker will drop it, to avoid having duplicate records per partition. The broker will drop the messages with a sequence less or equals to the last committed sequence number, and accept the other ones. In the diagram below, the 3nd message in the batch did not get an acknowledge, so the producer resends the batch, and the brokers reject duplicates and accept the 3nd message.</p>
<p><img alt="Excatly once - retries" src="../images/exactly-one-2.png" /></p>
<p>The sequence number is persisted in a log so even in case of broker leader failure, the new leader will have a good view of the states of the system.</p>
<div class="admonition note">
<p class="admonition-title">Note<p>The replication mechanism guarantees that when a message is written to the leader replica, it will be replicated to all available replicas.
As soon as you want to get acknowledge of all replicates, it is obvious to set idempotence to true. It does not impact performance.</p>
</p>
</div>
<p>To add to this discussion, as topic may have multiple partitions, kafka supports atomic writes to all partitions, so that all records are saved or none of them are visible to consumers. This transaction control is done by using the producer transactional API, and a unique transaction identifier is added to the message sent to keep integrated state. Here is an example of such configuration that can be done in a producer contructor method:</p>
<div class="codehilite"><pre><span></span><span class="n">producerProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;enable.idempotence&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>
<span class="n">producerProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;transactional.id&quot;</span><span class="o">,</span> <span class="s">&quot;prod-1&quot;</span><span class="o">);</span>
<span class="n">kafkaProducer</span><span class="o">.</span><span class="na">initTransactions</span><span class="o">()</span>
</pre></div>

<p><code>initTransactions()</code> registers the producer with the broker as one that can use transaction, identifying it by its transactional.id and a sequence number, or epoch.</p>
<p>In case of multiple partitions, the broker will store a list of all updated partitions for a given transaction.</p>
<p>See the <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/53bbb8cdeac413883ca2ccf521eb0797a43f45a3/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderCommandProducer.java#L46">code in order command</a> microservice.</p>
<p>The consumer is also interested to configure the reading of the transactional messages by defining the isolation level. Consumer waits to read transactional messages until the associated transaction has been committed. Here is an example of consumer code and configuration</p>
<div class="codehilite"><pre><span></span><span class="n">consumerProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;enable.auto.commit&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">);</span>
<span class="n">consumerProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;isolation.level&quot;</span><span class="o">,</span> <span class="s">&quot;read_committed&quot;</span><span class="o">);</span>
</pre></div>

<p>With <code>read_committed</code>, no message that was written to the input topic in the same transaction will be read by this consumer until message replicas are all written.</p>
<p>The consumer commits its offset with code, and specifies the last offset to read.</p>
<div class="codehilite"><pre><span></span><span class="n">offsetsToCommit</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">partition</span><span class="o">,</span> <span class="k">new</span> <span class="n">OffsetAndMetadata</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
<span class="n">producer</span><span class="o">.</span><span class="na">sendOffsetsToTransaction</span><span class="o">(</span><span class="n">offsetsToCommit</span><span class="o">,</span> <span class="s">&quot;order-group-id&quot;</span><span class="o">);</span>
</pre></div>

<p>The producer then commits the transaction.</p>
<div class="codehilite"><pre><span></span><span class="k">try</span> <span class="o">{</span>
    <span class="n">kafkaProducer</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
    <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProducerRecord</span><span class="o">&lt;&gt;(</span><span class="n">ApplicationConfig</span><span class="o">.</span><span class="na">ORDER_COMMAND_TOPIC</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="n">Future</span><span class="o">&lt;</span><span class="n">RecordMetadata</span><span class="o">&gt;</span> <span class="n">send</span> <span class="o">=</span> <span class="n">kafkaProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
    <span class="n">send</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ApplicationConfig</span><span class="o">.</span><span class="na">PRODUCER_TIMEOUT_SECS</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
    <span class="n">kafkaProducer</span><span class="o">.</span><span class="na">commitTransaction</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KafkaException</span> <span class="n">e</span><span class="o">){</span>
    <span class="n">kafkaProducer</span><span class="o">.</span><span class="na">abortTransaction</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<p>There is an interesting <a href="https://www.baeldung.com/kafka-exactly-once">article</a> from the Baeldung team about exactly once processing in kafka with code example.</p>
<h2 id="code-examples">Code Examples</h2>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms">Order management with CQRS in Java</a></li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms">Springboot with kafka template</a></li>
<li><a href="https://github.com/jbcodeforce/microprofile-event-driven-microservice-template/">Event driven microservice template</a></li>
</ul>
<h2 id="more-readings">More readings</h2>
<ul>
<li><a href="http://cloudurable.com/blog/kafka-tutorial-kafka-producer-advanced-java-examples/index.html">Creating advanced kafka producer in java - Cloudurable</a></li>
<li><a href="https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/">Confluent blog: Exactly-once Semantics are Possible: Here’s How Kafka Does it</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../arch/" title="Architecture considerations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Architecture considerations
              </span>
            </div>
          </a>
        
        
          <a href="../consumers/" title="Kafka consumer development practices" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Kafka consumer development practices
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>