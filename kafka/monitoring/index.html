



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Kafka Monitoring - Event Driven Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#monitoring-kafka-with-prometheus-and-grafana" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Event Driven Architecture" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Event Driven Architecture
            </span>
            <span class="md-header-nav__topic">
              Kafka Monitoring
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Event Driven Architecture" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Event Driven Architecture
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-eda/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../architecture/" title="Reference diagrams" class="md-nav__link">
      Reference diagrams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-src/" title="Event Sources" class="md-nav__link">
      Event Sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-backbone/" title="Event Backbone" class="md-nav__link">
      Event Backbone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-action/" title="Event Actions" class="md-nav__link">
      Event Actions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-state/" title="Event Managed States" class="md-nav__link">
      Event Managed States
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../arch/" title="Event Stream - Kafka architecture" class="md-nav__link">
      Event Stream - Kafka architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data-replication/" title="Data Replication Pattern" class="md-nav__link">
      Data Replication Pattern
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Event Storming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Event Storming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/readme/" title="Event Storming Workshop" class="md-nav__link">
      Event Storming Workshop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/analysis/readme/" title="Applied to Container Shipment Analysis" class="md-nav__link">
      Applied to Container Shipment Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/ddd/" title="Domain driven design" class="md-nav__link">
      Domain driven design
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Event driven patterns
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Event driven patterns
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../evt-microservices/ED-patterns/" title="Event-driven patterns" class="md-nav__link">
      Event-driven patterns
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kafka-stream/" title="Event streaming processing" class="md-nav__link">
      Event streaming processing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data-replication/" title="Data Replication Pattern" class="md-nav__link">
      Data Replication Pattern
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../rt-analytics/" title="Real time analytics" class="md-nav__link">
      Real time analytics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Reference implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Reference implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc" title="Container shipment implementation solution" class="md-nav__link">
      Container shipment implementation solution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Product guidances
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Product guidances
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../arch/" title="Kafka architecture" class="md-nav__link">
      Kafka architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../readme/" title="Kafka concepts summary" class="md-nav__link">
      Kafka concepts summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../producers/" title="Kafka producer" class="md-nav__link">
      Kafka producer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../consumers/" title="Kafka consumer" class="md-nav__link">
      Kafka consumer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/kafka/" title="Kafka deployment" class="md-nav__link">
      Kafka deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/zookeeper/" title="Zookeeper deployment" class="md-nav__link">
      Zookeeper deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/eventstreams/" title="Event Streams ICP deployment" class="md-nav__link">
      Event Streams ICP deployment
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kafka Monitoring
      </label>
    
    <a href="./" title="Kafka Monitoring" class="md-nav__link md-nav__link--active">
      Kafka Monitoring
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-to-monitor" title="What to monitor" class="md-nav__link">
    What to monitor
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-server-and-agents" title="Configuring server and agents" class="md-nav__link">
    Configuring server and agents
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka-and-zookeeper-servers-with-jmx-exporter" title="Kafka and Zookeeper servers with JMX Exporter" class="md-nav__link">
    Kafka and Zookeeper servers with JMX Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-server-and-scrape-jobs" title="Prometheus Server and scrape jobs" class="md-nav__link">
    Prometheus Server and scrape jobs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana-server-and-dashboards" title="Grafana Server and dashboards" class="md-nav__link">
    Grafana Server and dashboards
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../serverless/" title="Serverless" class="md-nav__link">
      Serverless
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/postgresql/" title="Postgresql" class="md-nav__link">
      Postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../eda-skill-journey/" title="Skill Journey" class="md-nav__link">
      Skill Journey
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../compendium/" title="Compendium" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-to-monitor" title="What to monitor" class="md-nav__link">
    What to monitor
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-server-and-agents" title="Configuring server and agents" class="md-nav__link">
    Configuring server and agents
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka-and-zookeeper-servers-with-jmx-exporter" title="Kafka and Zookeeper servers with JMX Exporter" class="md-nav__link">
    Kafka and Zookeeper servers with JMX Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-server-and-scrape-jobs" title="Prometheus Server and scrape jobs" class="md-nav__link">
    Prometheus Server and scrape jobs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana-server-and-dashboards" title="Grafana Server and dashboards" class="md-nav__link">
    Grafana Server and dashboards
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-eda/edit/master/docs/kafka/monitoring.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="monitoring-kafka-with-prometheus-and-grafana">Monitoring Kafka with Prometheus and Grafana</h1>
<p><em>Author: Ana Giordano - IBM</em></p>
<p>A comprehensive Kafka monitoring plan should collect metrics from the following components:</p>
<ul>
<li>Kafka Broker(s)</li>
<li>Kafka Cluster (which should include ZooKeeper metrics as Kafka relies on it to maintain its state)</li>
<li>Producer(s) / Consumer(s)</li>
</ul>
<p>Kafka Broker, Zookeeper and Java clients (producer/consumer) expose metrics via JMX (Java Management Extensions) and can be configured to report stats back to Prometheus using the <a href="https://github.com/prometheus/jmx_exporter">JMX exporter</a> maintained by Prometheus.  There is also a number of exporters maintained by the community to explore. Some of them can be used in addition to the JMX export. To monitor Kafka, for example, the JMX exporter is often used to provide broker level metrics, while community exporters claim to provide more accurate cluster level metrics (e.g. <a href="https://github.com/danielqsj/kafka_exporter">Kafka exporter</a>, <a href="https://github.com/cloudflare/kafka_zookeeper_exporter">Kafka Zookeeper Exporter by CloudFlare</a>, and others). Alternatively, you can consider <a href="https://prometheus.io/docs/instrumenting/writing_exporters/">writing your own custom exporter</a>.</p>
<h2 id="what-to-monitor">What to monitor</h2>
<p>A long list of metrics is made available by Kafka (<a href="https://kafka.apache.org/documentation/#monitoring">here</a>) and Zookeeper (<a href="https://zookeeper.apache.org/doc/current/zookeeperJMX.html">here</a>). The easiest way to see the available metrics is to fire up <em>jconsole</em> and point it at a running kafka client or Kafka/Prometheus server; this will allow browsing all metrics with JMX. But you are still left to figure out which ones you want to actively monitor and the ones that you want to be actively alerted.</p>
<p>An simple way to get started would be to start with the <a href="https://grafana.com/dashboards">Grafana’s sample dashboards</a> for the Prometheus exporters you chose to use and then modify them as you learn more about the available metrics and/or your environment on ICP. The <a href="https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/">Monitoring Kafka metrics</a> article by <em>DataDog</em> and <a href="https://blog.serverdensity.com/how-to-monitor-kafka/">How to monitor Kafka</a> by <em>Server Density</em> provides  guidance on key Kafka and Prometheus metrics, reasoning to why you should care about them and suggestions on thresholds to trigger alerts. In the next section, we will demonstrate exactly that; we will start with sample dashboards and make few modifications to exemplify how to configure key Kafka metrics to display in the dashboard.</p>
<h3 id="configuring-server-and-agents">Configuring server and agents</h3>
<p>For convenience and easy configuration, we will use Docker images from DockerHub and make few modifications to DockerFiles to include few additional steps to install, configure and start the servers and exporter agents locally.</p>
<h4 id="kafka-and-zookeeper-servers-with-jmx-exporter"><font color=blue>Kafka and Zookeeper servers with JMX Exporter</font></h4>
<p>We will start with the DockerFile of the <a href="https://hub.docker.com/r/spotify/kafka/~/DockerFile/">Spotify kafka image</a> from DockerHub as it includes Zookeeper and Kafka in a single image. The DockerFile was modified as shown below to download, install the Prometheus JMX exporter. The exporter can be configured to scrape and expose mBeans of a JMX target. It runs as a Java Agent, exposing a HTTP server and serving metrics of the JVM. In the DockerFile below, Kafka is started with JMX exporter agent on port 7071 and metrics will be expose in the /metrics endpoint.</p>
<pre><code>FROM java:openjdk-8-jre

ENV DEBIAN_FRONTEND noninteractive
ENV SCALA_VERSION 2.11
ENV KAFKA_VERSION 0.10.2.2
ENV KAFKA_HOME /opt/kafka_&quot;$SCALA_VERSION&quot;-&quot;$KAFKA_VERSION&quot;

# Install Kafka, Zookeeper and other needed things
RUN apt-get update &amp;&amp; \
    apt-get install -y zookeeper wget supervisor dnsutils vim &amp;&amp; \
    rm -rf /var/lib/apt/lists/* &amp;&amp; \
    apt-get clean &amp;&amp; \
    wget -q http://apache.mirrors.spacedump.net/kafka/&quot;$KAFKA_VERSION&quot;/kafka_&quot;$SCALA_VERSION&quot;-&quot;$KAFKA_VERSION&quot;.tgz -O /tmp/kafka_&quot;$SCALA_VERSION&quot;-&quot;$KAFKA_VERSION&quot;.tgz &amp;&amp; \
    tar xfz /tmp/kafka_&quot;$SCALA_VERSION&quot;-&quot;$KAFKA_VERSION&quot;.tgz -C /opt &amp;&amp; \
    rm /tmp/kafka_&quot;$SCALA_VERSION&quot;-&quot;$KAFKA_VERSION&quot;.tgz

ADD scripts/start-kafka.sh /usr/bin/start-kafka.sh
# ADD scripts/jmx_prometheus_javaagent-0.9.jar &quot;$KAFKA_HOME&quot;/jmx_prometheus_javaagent-0.9.jar
# ADD scripts/kafka-0-8-2.yml &quot;$KAFKA_HOME&quot;/kafka-0-8-2.yml

# Supervisor config
ADD supervisor/kafka.conf supervisor/zookeeper.conf /etc/supervisor/conf.d/

# 2181 is zookeeper, 9092 is kafka
EXPOSE 2181 9092

# **********
# start - modifications to run Prometheus JMX exporter and community Kafka exporter agents
ENV KAFKA_OPTS &quot;-javaagent:$KAFKA_HOME/jmx_prometheus_javaagent-0.9.jar=7071:$KAFKA_HOME/kafka-0-8-2.yml&quot;

RUN wget -q https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.9/jmx_prometheus_javaagent-0.9.jar -O &quot;$KAFKA_HOME&quot;/jmx_prometheus_javaagent-0.9.jar &amp;&amp; \
    wget -q https://raw.githubusercontent.com/prometheus/jmx_exporter/master/example_configs/kafka-0-8-2.yml -O &quot;$KAFKA_HOME&quot;/kafka-0-8-2.yml

EXPOSE 7071
# end - modifications
# **********

CMD [&quot;supervisord&quot;, &quot;-n&quot;]
</code></pre>

<p>For your convenience, the modified DockerFile and scripts are available on this <a href="https://github.com/anagiordano/ibm-artifacts">GitHub repository</a>. You can run the following commands to create and run the container locally.</p>
<ol>
<li>download git repo with DockerFile and scripts</li>
</ol>
<pre><code>mkdir /tmp/monitor
git clone https://github.com/anagiordano/ibm-artifacts.git /tmp/monitor/.
</code></pre>

<ol>
<li>Build image from DockerFile</li>
</ol>
<pre><code>docker build --tag kafka_i /tmp/monitor/kafka/.
</code></pre>

<ol>
<li>Create/Run Docker container</li>
</ol>
<pre><code>docker run -d -p 2181:2181 -p 9092:9092 -p 7071:7071 --env ADVERTISED_PORT=9092 --name kafka_c kafka_i
</code></pre>

<ol>
<li>Create kafka topics</li>
</ol>
<pre><code>docker exec -it kafka_c /bin/bash
cd /opt/kafka*/bin
export KAFKA_OPTS=&quot;&quot;
./kafka-topics.sh --create --zookeeper localhost:2181 --replication-fact 1 --partitions 1 --topic my-topic1
./kafka-topics.sh --create --zookeeper localhost:2181 --replication-fact 1 --partitions 1 --topic my-topic2
./kafka-topics.sh --list --zookeeper localhost:2181
</code></pre>

<ol>
<li>(optional) Produce few message into
topics from console and exit container</li>
</ol>
<pre><code>./kafka-console-producer.sh --broker-list localhost:9092 --topic my-topic1
./kafka-console-producer.sh --broker-list localhost:9092 --topic my-topic2
exit
</code></pre>

<p>Lastly you can validate that the /metrics endpoint is returning metrics from Kafka. On a browser, open the http://localhost:7071/metrics URL.</p>
<p><img alt="" src="../images/metrics-endpoint.png" /></p>
<h4 id="prometheus-server-and-scrape-jobs"><font color=blue>Prometheus Server and scrape jobs</font></h4>
<p>Prometheus uses a configuration file in YAML format to define the <a href="https://prometheus.io/docs/concepts/jobs_instances/">scraping jobs and their instances</a>. You can also use the configuration file to define <a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/">recording rules</a> and <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">alerting rules</a>:</p>
<ul>
<li>
<p><strong>Recording rules</strong> allow you to precompute frequently needed or computationally expensive expressions and save their result as a new set of time series. Querying the precomputed result will then often be much faster than executing the original expression every time it is needed. This is especially useful for dashboards, which need to query the same expression repeatedly every time they refresh.</p>
</li>
<li>
<p><strong>Alerting rules</strong> allow you to define alert conditions based on Prometheus expression language expressions and to send notifications about firing alerts to an external service. Alerting rules in Prometheus servers send alerts to an Alertmanager. The <a href="https://prometheus.io/docs/alerting/alertmanager/">Alertmanager</a> then manages those alerts, including silencing, inhibition, aggregation and sending out notifications via methods such as email, PagerDuty and others.</p>
</li>
</ul>
<p>Below, we will go thru the steps to stand-up a local Prometheus server as a Docker container and to modify the configuration file to scrape Kafka metrics.</p>
<ol>
<li>Create/run a docker container using Prometheus official image from DockerHub</li>
</ol>
<pre><code>docker run -d -p 9090:9090 prom/prometheus
</code></pre>

<ol>
<li>Obtain the IP address of the Kafka container</li>
</ol>
<pre><code>docker inspect kafka_c | grep IPAddress
</code></pre>

<ol>
<li>Edit the prometheus.yml to add Kafka as a target</li>
</ol>
<pre><code>docker exec -it prometheus_c \sh
vi /etc/prometheus/prometheus.yml
</code></pre>

<ol>
<li>Locate the scrape_configs section in the properties file and add the lines below to define the Kafka job,
where the IP should be the IP of the kafka container</li>
</ol>
<pre><code>  - job_name: 'kafka'                                                          

    static_configs:                                                            
    - targets: ['172.17.0.4:7071']

</code></pre>

<ol>
<li>Reload the configuration file</li>
</ol>
<pre><code>ps -ef
kill -HUP &lt;prometheus PID&gt;
</code></pre>

<ol>
<li>You can now verify that Kafka is listed as a target job in Prometheus. On a Browser, open the http://localhost:9090/targets URL.</li>
</ol>
<p><img alt="" src="../images/prometheus-targets.png" /></p>
<h4 id="grafana-server-and-dashboards"><font color=blue>Grafana Server and dashboards</font></h4>
<p>We will use Grafana for visualization of the metrics scraped by Prometheus for that, we will need to:</p>
<ul>
<li>Stand-up a local Grafana server as a Docker container</li>
<li>Configure Prometheus as a data source in Grafana</li>
<li>Import sample dashboards provided by Grafana and/or community</li>
<li>Modify the sample dashboards as we see fit</li>
</ul>
<p>Let’s get started:</p>
<ol>
<li>Create a docker container using Prometheus official image from DockerHub</li>
</ol>
<pre><code>docker run -d --name=grafana_c -p 3000:3000 grafana/grafana
</code></pre>

<ol>
<li>
<p>On a Browser, open the http://localhost:3000 URL.</p>
</li>
<li>
<p>Login as <strong>admin/admin</strong>. You will be prompted to change the password.</p>
</li>
<li>
<p>Once logged in, Grafana provides visual guidance on what the next steps are: a) Add data sources b) Create first dashboard and others</p>
</li>
</ol>
<p><img alt="" src="../images/grafana-url.png" /></p>
<ol>
<li>
<p>Configure Prometheus as a data source:</p>
</li>
<li>
<p>Enter a <strong>Name</strong> for the data source (e.g. Prometheus)</p>
</li>
<li>Select <strong>Prometheus</strong> as <strong>Type</strong></li>
<li>Enter <strong>http://localhost:9090</strong> for <strong>HTTP URL</strong></li>
<li>In our simple server configuration, select <strong>Browser</strong> for <strong>HTTP Access</strong>  </li>
<li>Click <strong>Save and Test</strong> to validate configuration</li>
</ol>
<p><img alt="" src="../images/grafana-data-source.png" /></p>
<ol>
<li>
<p>Back to Home, click Dashboards -&gt; Manage to import sample dashboards</p>
</li>
<li>
<p>Click the <strong>+Import</strong> button and paste this URL <strong>https://grafana.com/dashboards/721</strong></p>
</li>
<li>Make sure to select <strong>Prometheus</strong> as the data source.</li>
</ol>
<p><strong><em>NOTE:</em></strong> You can also explore other sample dashboard options at https://grafana.com/dashboards. For instance, there is a <a href="https://grafana.com/dashboards/762">Kubernetes Kafka resource metrics</a> sample dashboard that you could use instead as the starting point when configuring Kafka monitoring on ICP.</p>
<p><img alt="" src="../images/grafana-dashboard-import.png" /></p>
<p><img alt="" src="../images/grafana-dashboard-sample.png" /></p>
<p>The six graphs displayed in the dashboard are configured as follows:</p>
<p><strong><em>NOTE:</em></strong> You might want to go back to your Kafka Docker container and push messages into the topics you have created above to see changes to the graph. Or, if you have already pushed messages, you can change the Quick Range from last <em>5 minutes</em> to something else (e.g. <em>last 6 hours</em>) on the top right hand corner of the dashboard.</p>
<table>
<thead>
<tr>
<th align="left">Graph</th>
<th align="left">Formula</th>
<th align="left">Format As</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">CPU Usage</td>
<td align="left">rate(process_cpu_seconds_total{job="kafka"}[1m])</td>
<td align="left">Time Series</td>
</tr>
<tr>
<td align="left">JVM Memory Used</td>
<td align="left">sum without(area)(jvm_memory_bytes_used{job="kafka"})</td>
<td align="left">Time Series</td>
</tr>
<tr>
<td align="left">Time spent in GC</td>
<td align="left">sum without(gc)(rate(jvm_gc_collection_seconds_sum{job="kafka"}[5m]))</td>
<td align="left">Time Series</td>
</tr>
<tr>
<td align="left">Messages In per Topic</td>
<td align="left">sum without(instance)(rate(kafka_server_brokertopicmetrics_messagesin_total{job="kafka",topic!=""}[5m]))</td>
<td align="left">Time Series</td>
</tr>
<tr>
<td align="left">Bytes In per Topic</td>
<td align="left">sum without(instance)(rate(kafka_server_brokertopicmetrics_bytesin_total{job="kafka",topic!=""}[5m]))</td>
<td align="left">Time Series</td>
</tr>
<tr>
<td align="left">Bytes Out per Topic</td>
<td align="left">sum without(instance)(rate(kafka_server_brokertopicmetrics_bytesout_total{job="kafka",topic!=""}[5m]))</td>
<td align="left">Time Series</td>
</tr>
</tbody>
</table>
<p>Prometheus provides a functional expression language that lets the user select and aggregate time series data in real time. Before proceeding review the information on these pages to gain basic understanding of:</p>
<ul>
<li>Prometheus Expression language - http://docs.grafana.org/features/datasources/prometheus/</li>
<li>Grafana Query Editor - http://docs.grafana.org/features/datasources/prometheus/</li>
</ul>
<p>As you make modifications to the dashboard it is also important to understand the data returned by the scrape jobs in the first place. For two of the metrics above, this is what the Kafka JMX exportex returns. You can go to https://localhost:7071/metrics to inspect others returned in /metrics endpoint response:</p>
<ul>
<li>Messages in Per Topic</li>
</ul>
<p><img alt="" src="../images/metrics_messagesin.png" /></p>
<ul>
<li>Time spent in GC</li>
</ul>
<p><img alt="" src="../images/metrics_gc.png" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../deployments/eventstreams/" title="Event Streams ICP deployment" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Event Streams ICP deployment
              </span>
            </div>
          </a>
        
        
          <a href="../../serverless/" title="Serverless" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Serverless
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>